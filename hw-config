#! /bin/bash

set -x

pushd /root/isdn--devel > /dev/null

modprobe ppp_generic
insmod visdn-core/visdn-core.ko
insmod visdn-cxc-internal/visdn-cxc-internal.ko
insmod lapd/lapd.ko
insmod visdn-netdev/visdn-netdev.ko
insmod visdn-streamport/visdn-streamport.ko
#insmod visdn-ppp/visdn-ppp.ko
insmod visdn-timer-system/visdn-timer-system.ko
insmod hfc-4s/hfc-4s.ko debug_level=3
insmod hfc-pci/hfc-pci.ko debug_level=3

popd > /dev/null

set +x

function create_netdev()
{
	exec 6<>/dev/visdn/netdev-control
	echo "create lapd" >&6
	read -u 6 NETDEV_DEV
	read -u 6 NETDEV_CHAN_D
	read -u 6 NETDEV_CHAN_E
	exec 6<&-
}

function connect_channels()
{
	local CHAN1=$1
	local CHAN2=$2

	echo "$CHAN1,$CHAN2" > /sys/visdn_tdm/internal-cxc/connect
}

function config_if()
{
	local DEVICE_ID=$1
	local PORT_ID=$2
	local NETDEV_NAME=$3
	local ROLE=$4

        pushd "/sys/$DEVICE_ID" > /dev/null || ( echo "Invalid device ID"; return )

	pushd $PORT_ID > /dev/null || ( echo "Missing port"; return )

	if [ ! -f role ]; then
		echo "Missing role"
		return
	fi

	if [ ! -f enabled ]; then
		echo "Missing enabled"
		return
	fi

	if [ ! -f /sys/visdn_tdm/internal-cxc/connect ]; then
		echo "Missing connect"
		return
	fi

	if [ ! -c /dev/visdn/netdev-control ]; then
		echo "Missing netdev-control";
		return
	fi

	if [ ! -L D ]; then
		echo "Missing D channel";
		return
	fi

	if [ ! -L E ]; then
		echo "Missing E channel";
		return
	fi

	echo $ROLE > role

	local D_SYSFS_DIR=`readlink D`
	local D_CHAN=`basename $D_SYSFS_DIR`
	local E_SYSFS_DIR=`readlink E`
	local E_CHAN=`basename $E_SYSFS_DIR`

	if [ ! -L "$D_SYSFS_DIR/connected" ] ; then
		create_netdev

		connect_channels "${NETDEV_CHAN_D}" "$D_CHAN"
		connect_channels "${NETDEV_CHAN_E}" "$E_CHAN"

		ip link set ${NETDEV_DEV} name $NETDEV_NAME
	fi

	echo 1 > enabled

	if [ $ROLE = "NT" ] ; then
		ip link set $NETDEV_NAME allmulticast on
	else
		ip link set $NETDEV_NAME allmulticast off
	fi

	ip link set $NETDEV_NAME up
popd > /dev/null

popd > /dev/null
}

config_if "bus/pci/devices/0000:00:07.0" "st0" "visdn0" "TE"
config_if "bus/pci/devices/0000:00:09.0" "st0" "visdn1.0" "NT"
config_if "bus/pci/devices/0000:00:09.0" "st1" "visdn1.1" "NT"
config_if "bus/pci/devices/0000:00:09.0" "st2" "visdn1.2" "TE"
config_if "bus/pci/devices/0000:00:09.0" "st3" "visdn1.3" "TE"

